<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tab State QR - Restore Tabs</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0a0a0f; --card: #12121a; --border: rgba(255,255,255,0.1);
      --text: #e8e8f0; --dim: #666680; --accent: #7c3aed; --green: #10b981;
    }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
      background: var(--bg); color: var(--text); 
      min-height: 100vh; padding: 20px;
    }
    .container { max-width: 600px; margin: 0 auto; }
    h1 { font-size: 24px; margin-bottom: 8px; }
    .subtitle { color: var(--dim); margin-bottom: 24px; }
    .card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
    .tab-list { max-height: 400px; overflow-y: auto; }
    .tab-item { 
      display: flex; align-items: center; gap: 12px; 
      padding: 12px; border-radius: 8px; cursor: pointer;
      border: 1px solid transparent;
    }
    .tab-item:hover { background: rgba(255,255,255,0.05); }
    .tab-item.selected { border-color: var(--accent); background: rgba(124,58,237,0.1); }
    .tab-item input { width: 18px; height: 18px; accent-color: var(--accent); }
    .tab-favicon { width: 20px; height: 20px; border-radius: 4px; }
    .tab-info { flex: 1; min-width: 0; }
    .tab-title { font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .tab-domain { font-size: 12px; color: var(--dim); }
    .btn { 
      padding: 12px 24px; border: none; border-radius: 8px; 
      font-size: 14px; font-weight: 500; cursor: pointer; 
      display: inline-flex; align-items: center; gap: 8px;
    }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: #6d28d9; }
    .btn-secondary { background: var(--card); color: var(--text); border: 1px solid var(--border); }
    .actions { display: flex; gap: 12px; flex-wrap: wrap; }
    .stats { display: flex; gap: 20px; margin-bottom: 16px; }
    .stat { text-align: center; }
    .stat-value { font-size: 24px; font-weight: 700; color: var(--accent); }
    .stat-label { font-size: 12px; color: var(--dim); }
    .error { color: #ef4444; padding: 20px; text-align: center; }
    .paste-area { width: 100%; min-height: 120px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; color: var(--text); font-family: monospace; font-size: 12px; resize: vertical; margin-bottom: 16px; }
    .paste-area:focus { outline: none; border-color: var(--accent); }
    .select-all { display: flex; align-items: center; gap: 8px; padding: 12px; border-bottom: 1px solid var(--border); margin-bottom: 8px; cursor: pointer; }
    .select-all:hover { background: rgba(255,255,255,0.03); }
  </style>
</head>
<body>
  <div class="container">
    <h1>üì± Tab State QR</h1>
    <p class="subtitle">Restore your tabs on this device</p>
    <div id="content"></div>
  </div>

  <script>
    const TabStateParsers = {
      fromCompressed: (compressed) => {
        try {
          // Strip any URL prefix
          let data = compressed;
          if (data.includes('#')) {
            data = data.split('#')[1];
          }
          data = data.replace(/^tabstate:\/\//, '');
          
          // Decode base64
          const decoded = decodeURIComponent(escape(atob(data)));
          const urls = decoded.split('\n').filter(u => u.trim() && u.startsWith('http'));
          
          if (urls.length === 0) return null;
          
          return {
            tabs: urls.map(url => ({
              url,
              title: url,
              domain: getDomain(url)
            })),
            timestamp: Date.now()
          };
        } catch (e) {
          console.error('Parse error:', e);
          return null;
        }
      },
      
      auto: (input) => {
        input = input.trim();
        
        // Try as base64 directly (most common from hash)
        if (/^[A-Za-z0-9+/]+=*$/.test(input)) {
          const result = TabStateParsers.fromCompressed(input);
          if (result) return result;
        }
        
        // Try tabstate:// protocol
        if (input.startsWith('tabstate://')) {
          return TabStateParsers.fromCompressed(input);
        }
        
        // Try full URL with hash
        if (input.includes('#')) {
          const hash = input.split('#')[1];
          const result = TabStateParsers.fromCompressed(hash);
          if (result) return result;
        }
        
        // Try as URL list
        const urls = input.split('\n').filter(u => u.trim().startsWith('http'));
        if (urls.length > 0) {
          return {
            tabs: urls.map(url => ({ url, title: url, domain: getDomain(url) })),
            timestamp: Date.now()
          };
        }
        
        return null;
      }
    };
    
    function getDomain(url) {
      try { return new URL(url).hostname; } catch { return 'unknown'; }
    }
    
    function getFavicon(url) {
      try {
        return 'https://www.google.com/s2/favicons?domain=' + new URL(url).hostname + '&sz=32';
      } catch { return ''; }
    }
    
    let tabState = null;
    let selectedTabs = new Set();
    
    function init() {
      const hash = window.location.hash.slice(1);
      
      if (!hash) {
        showPasteUI();
        return;
      }
      
      tabState = TabStateParsers.auto(hash);
      
      if (!tabState || tabState.tabs.length === 0) {
        showError('Invalid or empty tab state. Try pasting manually below.');
        return;
      }
      
      selectedTabs = new Set(tabState.tabs.map((_, i) => i));
      showTabs();
    }
    
    function showPasteUI() {
      document.getElementById('content').innerHTML = `
        <div class="card">
          <h3 style="margin-bottom: 12px;">Paste tab state data</h3>
          <textarea class="paste-area" id="pasteInput" placeholder="Paste your tabstate:// URL or base64 data here..."></textarea>
          <button class="btn btn-primary" onclick="handlePaste()">Restore Tabs</button>
        </div>
      `;
    }
    
    function showError(msg) {
      document.getElementById('content').innerHTML = `
        <div class="card">
          <div class="error">‚ùå ${msg}</div>
          <h3 style="margin: 16px 0 12px;">Try pasting manually:</h3>
          <textarea class="paste-area" id="pasteInput" placeholder="Paste your tabstate:// URL or base64 data here..."></textarea>
          <button class="btn btn-primary" onclick="handlePaste()">Restore Tabs</button>
        </div>
      `;
    }
    
    function handlePaste() {
      const input = document.getElementById('pasteInput').value.trim();
      if (!input) return;
      
      tabState = TabStateParsers.auto(input);
      
      if (!tabState || tabState.tabs.length === 0) {
        alert('Could not parse tab data');
        return;
      }
      
      selectedTabs = new Set(tabState.tabs.map((_, i) => i));
      showTabs();
    }
    
    function showTabs() {
      const tabs = tabState.tabs;
      
      document.getElementById('content').innerHTML = `
        <div class="stats">
          <div class="stat">
            <div class="stat-value">${tabs.length}</div>
            <div class="stat-label">TABS</div>
          </div>
          <div class="stat">
            <div class="stat-value">${new Set(tabs.map(t => t.domain)).size}</div>
            <div class="stat-label">DOMAINS</div>
          </div>
        </div>
        
        <div class="card">
          <div class="select-all" onclick="toggleAll()">
            <input type="checkbox" id="selectAllCb" ${selectedTabs.size === tabs.length ? 'checked' : ''}>
            <span>Select All (${selectedTabs.size}/${tabs.length})</span>
          </div>
          <div class="tab-list" id="tabList">
            ${tabs.map((tab, i) => `
              <div class="tab-item ${selectedTabs.has(i) ? 'selected' : ''}" onclick="toggleTab(${i})">
                <input type="checkbox" ${selectedTabs.has(i) ? 'checked' : ''}>
                <img class="tab-favicon" src="${getFavicon(tab.url)}" onerror="this.style.display='none'">
                <div class="tab-info">
                  <div class="tab-title">${escapeHtml(tab.title || tab.url)}</div>
                  <div class="tab-domain">${tab.domain}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
        
        <div class="actions">
          <button class="btn btn-primary" onclick="openSelected()">üöÄ Open ${selectedTabs.size} Tabs</button>
          <button class="btn btn-secondary" onclick="copyUrls()">üìã Copy URLs</button>
        </div>
      `;
    }
    
    function toggleTab(i) {
      if (selectedTabs.has(i)) {
        selectedTabs.delete(i);
      } else {
        selectedTabs.add(i);
      }
      showTabs();
    }
    
    function toggleAll() {
      if (selectedTabs.size === tabState.tabs.length) {
        selectedTabs.clear();
      } else {
        selectedTabs = new Set(tabState.tabs.map((_, i) => i));
      }
      showTabs();
    }
    
    function openSelected() {
      const tabs = tabState.tabs.filter((_, i) => selectedTabs.has(i));
      tabs.forEach(tab => window.open(tab.url, '_blank'));
    }
    
    function copyUrls() {
      const tabs = tabState.tabs.filter((_, i) => selectedTabs.has(i));
      const text = tabs.map(t => t.url).join('\n');
      navigator.clipboard.writeText(text).then(() => alert('Copied ' + tabs.length + ' URLs!'));
    }
    
    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }
    
    init();
  </script>
</body>
</html>
